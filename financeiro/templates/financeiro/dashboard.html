{% extends 'core/base.html' %}
{% load static %}
{% load mathfilters %}
<!-- Certifique-se de carregar mathfilters -->
{% block content_title %}Dashboard Financeiro{% endblock %}
{% block content %}
<div class="container-fluid" style="width: 100%; padding-right: 0">
  <!-- Seção de Botões para Formulários -->
  <div class="row mt-4">
    <div class="col-12">
      <div class="card border-0 shadow-sm" style="border-radius: 15px">
        <div
          class="card-header bg-gradient"
          style="
            background: linear-gradient(45deg, #dc3545, #e4606d);
            border-top-left-radius: 15px;
            border-top-right-radius: 15px;
          "
        >
          <h4
            class="text-white m-0"
            style="
              font-size: 1.3rem;
              font-weight: 600;
              display: flex;
              align-items: center;
            "
          >
            <i class="bi bi-lightning-charge-fill me-2"></i> Ações Rápidas
          </h4>
        </div>
        <div
          class="card-body p-4"
          style="
            background: #fff;
            border-bottom-left-radius: 15px;
            border-bottom-right-radius: 15px;
          "
        >
          <div
            class="btn-group d-flex flex-wrap justify-content-between"
            role="group"
            aria-label="Ações rápidas"
          >
            <a
              href="{% url 'financeiro:criar_venda' %}"
              class="btn btn-success btn-lg text-white shadow-sm rounded-pill me-2 mb-2"
              style="color: #000"
            >
              <i class="fas fa-cart-plus"></i> Cadastrar Venda
            </a>
            <a
              href="{% url 'financeiro:criar_compra' %}"
              class="btn btn-primary btn-lg text-white shadow-sm rounded-pill me-2 mb-2"
              style="color: #000"
            >
              <i class="fas fa-truck"></i> Cadastrar Compra
            </a>
            <a
              href="{% url 'financeiro:criar_gasto' %}"
              class="btn btn-warning btn-lg text-white shadow-sm rounded-pill me-2 mb-2"
              style="color: #000"
            >
              <i class="fas fa-money-bill-wave"></i> Cadastrar Gasto Fixo
            </a>
            <a
              href="{% url 'financeiro:historico_transacoes' %}"
              class="btn btn-info btn-lg text-white shadow-sm rounded-pill mb-2"
              style="color: #000"
            >
              <i class="fas fa-history"></i> Ver Histórico
            </a>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Seção de Totais Financeiros -->
  <div class="row mt-4">
    <div class="col-md-3 col-sm-6 mb-3">
      <div class="card bg-success text-white" style="border-radius: 15px">
        <div class="card-body text-center p-4">
          <h5 class="card-title" style="font-size: 1.2rem; font-weight: 600">
            Total de Vendas
          </h5>
          <p class="card-text display-6" style="color: #000">
            R$ {{ total_vendas|floatformat:2 }}
          </p>
        </div>
      </div>
    </div>
    <div class="col-md-3 col-sm-6 mb-3">
      <div class="card bg-danger text-white" style="border-radius: 15px">
        <div class="card-body text-center p-4">
          <h5 class="card-title" style="font-size: 1.2rem; font-weight: 600">
            Total de Compras
          </h5>
          <p class="card-text display-6" style="color: #000">
            R$ {{ total_compras|floatformat:2 }}
          </p>
        </div>
      </div>
    </div>
    <div class="col-md-3 col-sm-6 mb-3">
      <div class="card bg-warning text-white" style="border-radius: 15px">
        <div class="card-body text-center p-4">
          <h5 class="card-title" style="font-size: 1.2rem; font-weight: 600">
            Total de Gastos Fixos
          </h5>
          <p class="card-text display-6" style="color: #000">
            R$ {{ total_gastos_fixos|floatformat:2 }}
          </p>
        </div>
      </div>
    </div>
    <div class="col-md-3 col-sm-6 mb-3">
      <div class="card bg-primary text-white" style="border-radius: 15px">
        <div class="card-body text-center p-4">
          <h5 class="card-title" style="font-size: 1.2rem; font-weight: 600">
            Saldo do Caixa
          </h5>
          <p class="card-text display-6" style="color: #000">
            R$ {{ saldo_caixa|floatformat:2 }}
          </p>
        </div>
      </div>
    </div>
  </div>

  <!-- Seção de Gastos Fixos -->
  <div class="row mt-4">
    <div class="col-12">
      <div class="card border-0 shadow-sm" style="border-radius: 15px">
        <div
          class="card-header bg-gradient"
          style="
            background: linear-gradient(45deg, #dc3545, #e4606d);
            border-top-left-radius: 15px;
            border-top-right-radius: 15px;
          "
        >
          <h2
            class="card-title text-white m-0"
            style="font-size: 1.3rem; font-weight: 600"
          >
            Gastos Fixos
          </h2>
        </div>
        <div
          class="card-body p-4"
          style="
            background: #fff;
            border-bottom-left-radius: 15px;
            border-bottom-right-radius: 15px;
          "
        >
          {% if gastos_fixos %}
          <table class="table table-striped" style="color: #000">
            <thead>
              <tr>
                <th style="font-size: 1rem; font-weight: 500">Descrição</th>
                <th style="font-size: 1rem; font-weight: 500">Valor (R$)</th>
                <th style="font-size: 1rem; font-weight: 500">Dia de Pagamento</th>
                <th style="font-size: 1rem; font-weight: 500">Alerta</th>
                <th style="font-size: 1rem; font-weight: 500">Ações</th>
              </tr>
            </thead>
            <tbody>
              {% for gasto in gastos_fixos %}
              <tr>
                <td style="font-size: 1rem; font-weight: 400">{{ gasto.descricao }}</td>
                <td style="font-size: 1rem; font-weight: 400">{{ gasto.valor|floatformat:2 }}</td>
                <td style="font-size: 1rem; font-weight: 400">{{ gasto.dia_pagamento }}</td>
                <td>
                  {% now "j" as dia_atual %}
                  {% if dia_atual|add:"0" == gasto.dia_pagamento %}
                    <span class="badge bg-danger" style="color: #fff">Atenção: Pagar Hoje!</span>
                  {% elif dia_atual|add:"0" > gasto.dia_pagamento and dia_atual|add:"0" < gasto.dia_pagamento|add:"5" %}
                    <span class="badge bg-warning" style="color: #000">Atrasado/Vencendo em breve</span>
                  {% else %}
                    <span class="badge bg-success" style="color: #fff">Em dia</span>
                  {% endif %}
                </td>
                <td>
                  <a href="{% url 'financeiro:editar_gasto' gasto.pk %}" class="btn btn-primary btn-sm" style="color: #000">Editar</a>
                  <a href="#" class="btn btn-danger btn-sm" data-bs-toggle="modal" data-bs-target="#deleteModal{{ gasto.pk }}" style="color: #000">Deletar</a>
                </td>
              </tr>
              <!-- Modal for each gasto -->
              <div class="modal fade" id="deleteModal{{ gasto.pk }}" tabindex="-1" aria-labelledby="deleteModalLabel{{ gasto.pk }}" aria-hidden="true">
                <div class="modal-dialog">
                  <div class="modal-content" style="border-radius: 0">
                    <div class="modal-header">
                      <h5 class="modal-title" id="deleteModalLabel{{ gasto.pk }}" style="color: #000; font-size: 1.2rem; font-weight: 600">Confirmar Deleção</h5>
                      <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body" style="color: #000; font-size: 1rem; font-weight: 400">
                      Tem certeza que deseja deletar o gasto "{{ gasto.descricao }}"?
                    </div>
                    <div class="modal-footer">
                      <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" style="color: #000">Cancelar</button>
                      <form method="post" action="{% url 'financeiro:deletar_gasto' gasto.pk %}">
                        {% csrf_token %}
                        <button type="submit" class="btn btn-danger" style="color: #000">Deletar</button>
                      </form>
                    </div>
                  </div>
                </div>
              </div>
              {% endfor %}
            </tbody>
            <tfoot>
              <tr>
                <td style="font-size: 1rem; font-weight: 600"><strong>Total</strong></td>
                <td style "font-size: 1rem; font-weight: 600"><strong>R$ {{ total_gastos_fixos_tabela|floatformat:2 }}</strong></td>
                <td colspan="3"></td>
              </tr>
            </tfoot>
          </table>
          {% else %}
          <p class="text-muted" style="color: #000; font-size: 1rem; font-weight: 400">Nenhum gasto fixo cadastrado.</p>
          {% endif %}
          <a href="{% url 'financeiro:criar_gasto' %}" class="btn btn-success mt-3" style="color: #000">Adicionar Gasto Fixo</a>
        </div>
      </div>
    </div>
  </div>

  <!-- Seção de Gastos Variáveis (Compras) -->
  <div class="row mt-4">
    <div class="col-12">
      <div class="card border-0 shadow-sm" style="border-radius: 15px">
        <div
          class="card-header bg-gradient"
          style="
            background: linear-gradient(45deg, #dc3545, #e4606d);
            border-top-left-radius: 15px;
            border-top-right-radius: 15px;
          "
        >
          <h2
            class="card-title text-white m-0"
            style="font-size: 1.3rem; font-weight: 600"
          >
            Gastos Variáveis (Compras)
          </h2>
        </div>
        <div
          class="card-body p-4"
          style="
            background: #fff;
            border-bottom-left-radius: 15px;
            border-bottom-right-radius: 15px;
          "
        >
          {% if compras_com_totais %}
          <table class="table table-striped" style="color: #000">
            <thead>
              <tr>
                <th style="font-size: 1rem; font-weight: 500">Ingrediente</th>
                <th style="font-size: 1rem; font-weight: 500">Quantidade</th>
                <th style="font-size: 1rem; font-weight: 500">Valor Unitário (R$)</th>
                <th style="font-size: 1rem; font-weight: 500">Total (R$)</th>
                <th style="font-size: 1rem; font-weight: 500">Data</th>
                <th style="font-size: 1rem; font-weight: 500">Ações</th>
              </tr>
            </thead>
            <tbody>
              {% for compra in compras_com_totais %}
              {% with unidade=compra.ingrediente.unidade_medida|default:'' %}
              <tr>
                <td style="font-size: 1rem; font-weight: 400">{{ compra.ingrediente }}</td>
                <td style="font-size: 1rem; font-weight: 400">
                  {% if compra.quantidade >= 1 %}
                    {{ compra.quantidade|floatformat:1 }} {{ unidade }}
                    {% with resto=compra.quantidade|mul:10|mod:10 %}
                      {% if resto > 0 %}
                        ({{ compra.quantidade|mul:10|div:10|floatformat:0 }} {{ unidade }} e {{ resto|mul:100 }} g)
                      {% endif %}
                    {% endwith %}
                  {% else %}
                    {{ compra.quantidade|mul:1000|floatformat:0 }} g
                  {% endif %}
                </td>
                <td style="font-size: 1rem; font-weight: 400">{{ compra.valor_unitario|floatformat:2 }}</td>
                <td style="font-size: 1rem; font-weight: 400">{{ compra.total|floatformat:2 }}</td>
                <td style=" table table-striped" style="color: #000">
                <td style="font-size: 1rem; font-weight: 400">{{ compra.data|date:"d/m/Y" }}</td>
                <td>
                  <a href="{% url 'financeiro:detalhes_compra' compra.pk %}" class="btn btn-info btn-sm" style="color: #000">Detalhes</a>
                </td>
              </tr>
              {% endwith %}
              {% endfor %}
            </tbody>
            <tfoot>
              <tr>
                <td style="font-size: 1rem; font-weight: 600"><strong>Total</strong></td>
                <td colspan="2"></td>
                <td style="font-size: 1rem; font-weight: 600"><strong>R$ {{ total_compras_tabela|floatformat:2 }}</strong></td>
                <td colspan="2"></td>
              </tr>
            </tfoot>
          </table>
          {% else %}
          <p class="text-muted" style="color: #000; font-size: 1rem; font-weight: 400">Nenhuma compra registrada.</p>
          {% endif %}
          <a href="{% url 'financeiro:criar_compra' %}" class="btn btn-primary mt-3" style="color: #000">Adicionar Compra</a>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}
{% block extra_scripts %}
<!-- Removido os scripts do gráfico temporariamente -->
<style>
  .btn-success:hover,
  .btn-primary:hover,
  .btn-warning:hover,
  .btn-info:hover {
    transform: translateY(-2px);
    transition: all 0.3s ease;
  }
  .btn-success:hover {
    background: linear-gradient(45deg, #218838, #2eca5a);
  }
  .btn-primary:hover {
    background: linear-gradient(45deg, #b02a37, #c44d58);
  }
  .btn-warning:hover {
    background: linear-gradient(45deg, #e0a800, #ffca2c);
  }
  .btn-info:hover {
    background: linear-gradient(45deg, #138496, #17a2b8);
  }
  @media (max-width: 768px) {
    .btn-group .btn {
      width: 100%;
      margin-bottom: 10px;
    }
  }
</style>
{% endblock %}